<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.backgroundColor = '#0b0e11';

    // Убедись, что этот адрес совпадает с тем, что выдал ngrok прямо сейчас!
    const API_URL = "https://plenteously-unpromising-emilee.ngrok-free.dev";

    let selectedService = "Сео";
    const prices = { "Сео": 130, "Архив": 250, "Залив": 100 };
    let userBalance = 0;

    // Улучшенное получение ID
    const urlParams = new URLSearchParams(window.location.search);
    const userId = tg.initDataUnsafe?.user?.id || urlParams.get('id');

    async function fetchUserData() {
        if (!userId) {
            console.error("ID не найден");
            document.getElementById('ui').innerText = "Не найден";
            document.getElementById('ub').innerText = "0";
            return;
        }

        try {
            // Запрос с защитой от кэширования
            const response = await fetch(`${API_URL}/get_balance/${userId}?t=${Date.now()}`);
            
            if (!response.ok) throw new Error(`Status: ${response.status}`);

            const data = await response.json();
            userBalance = data.balance;

            document.getElementById('ui').innerText = userId;
            document.getElementById('ub').innerText = userBalance.toFixed(2);
            updateButton();
        } catch (e) {
            console.error("Ошибка API:", e);
            document.getElementById('ub').innerText = "Ошибка API";
            // Если видишь эту ошибку, значит FastAPI не пускает запрос (CORS) или ngrok выключен
        }
    }

    async function handlePayment() {
        const taskText = document.getElementById('task').value.trim();
        const cost = prices[selectedService];

        if (userBalance < cost) {
            tg.showAlert("Недостаточно средств.");
            return;
        }

        tg.MainButton.showProgress();

        try {
            const response = await fetch(`${API_URL}/create_order`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: Number(userId),
                    service: selectedService,
                    desc: taskText,
                    price: cost
                })
            });

            const result = await response.json();
            if (result.status === "success") {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`✅ Заказ принят!`, () => { tg.close(); });
            } else {
                tg.showAlert("❌ " + result.message);
            }
        } catch (e) {
            tg.showAlert("Ошибка связи с сервером");
        } finally {
            tg.MainButton.hideProgress();
        }
    }

    // Твои функции навигации остаются без изменений
    function selectService(el, name) {
        tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.service-tile').forEach(t => t.classList.remove('selected'));
        el.classList.add('selected');
        selectedService = name;
        updateButton();
    }

    function switchTab(tab) {
        tg.HapticFeedback.impactOccurred('medium');
        document.getElementById('shop-page').classList.toggle('hidden', tab !== 'shop');
        document.getElementById('profile-page').classList.toggle('hidden', tab !== 'profile');
        document.getElementById('nav-shop').classList.toggle('active', tab === 'shop');
        document.getElementById('nav-profile').classList.toggle('active', tab === 'profile');
        tab === 'shop' ? tg.MainButton.show() : tg.MainButton.hide();
    }

    function openSupport() { tg.openTelegramLink('https://t.me/Alexandria_supp'); }

    function updateButton() {
        const cost = prices[selectedService];
        const hasText = document.getElementById('task').value.trim().length >= 5;
        if (hasText) {
            if (userBalance < cost) {
                tg.MainButton.setParams({text: `ПОПОЛНИТЕ БАЛАНС (${cost}₽)`, color: "#ef4444", is_active: true});
            } else {
                tg.MainButton.setParams({text: `ОПЛАТИТЬ ${selectedService.toUpperCase()} (${cost}₽)`, color: "#ffffff", text_color: "#000000", is_active: true});
            }
        } else {
            tg.MainButton.setParams({text: "ОПИШИТЕ ЗАДАЧУ (МИН. 5 СИМВ.)", color: "#1e293b", text_color: "#94a3b8", is_active: false});
        }
    }

    function sendDeposit() { tg.showAlert("Напишите сумму пополнения в чат с ботом."); }

    tg.onEvent('mainButtonClicked', handlePayment);
    fetchUserData();
    tg.MainButton.show();
    updateButton();
</script>
